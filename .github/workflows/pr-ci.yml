name: PR CI

on:
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install LLVM and Clang
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "17"
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Setup dependencies
      run: ./scripts/setup_dependencies.sh --skip-rerun --skip-dem
    
    - name: Cache cargo build
      uses: Swatinem/rust-cache@v2
    
    - name: Build
      run: cargo build --verbose
    
    - name: Run tests
      run: cargo test --verbose
